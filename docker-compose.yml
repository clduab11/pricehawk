version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: pricehawk
      POSTGRES_PASSWORD: password
      POSTGRES_DB: pricehawk
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  app:
    build:
      context: .
      dockerfile: Dockerfile
    command: node server.js
    environment:
      DATABASE_URL: postgres://pricehawk:password@postgres:5432/pricehawk
      REDIS_HOST: redis
      REDIS_PORT: 6379
      NEXT_PUBLIC_APP_URL: http://localhost:3000
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - redis

  # Separate service for Scraper because it needs Playwright browsers
  # We use the official Playwright image to ensure browsers are there
  worker-scraper:
    image: mcr.microsoft.com/playwright:v1.49.0-jammy
    working_dir: /app
    # We mount the code to run it
    volumes:
      - ./:/app
      - /app/node_modules
    command: /bin/bash -c "npm install && npx prisma generate && npx tsx src/worker.ts"
    environment:
      DATABASE_URL: postgres://pricehawk:password@postgres:5432/pricehawk
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - postgres
      - redis

  # Other workers can use the base App image (lighter) or the same playwright image if code is shared
  worker-validator:
    build: .
    command: tsx src/workers/anomaly-validator.ts
    environment:
      DATABASE_URL: postgres://pricehawk:password@postgres:5432/pricehawk
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - postgres
      - redis

  worker-notify:
    build: .
    command: tsx src/workers/notification-sender.ts
    environment:
      DATABASE_URL: postgres://pricehawk:password@postgres:5432/pricehawk
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - postgres
      - redis

  worker-social:
    build: .
    command: tsx src/workers/social-poster.ts
    environment:
      DATABASE_URL: postgres://pricehawk:password@postgres:5432/pricehawk
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - postgres
      - redis

  worker-verifier:
    build: .
    command: tsx src/workers/deal-verifier.ts
    environment:
      DATABASE_URL: postgres://pricehawk:password@postgres:5432/pricehawk
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - postgres
      - redis

volumes:
  postgres_data:
  redis_data:
